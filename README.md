# Stop_images

Streamlit-приложение для проверки изображений по новой механике:

1. На вход дается ссылка на **раздел сайта**.
2. Приложение скрапит ссылки на карточки товаров в разделе.
3. Для каждой карточки извлекает артикул и изображение.
4. Извлекает URL изображения и отправляет его в поле "Search by image url" на https://tineye.com/.
5. Переносит в отчет только ссылки из TinEye, начинающиеся на `https://www.shutterstock.com`.

## Отчет XLSX

Колонки отчета:

1. `Артикул товара`
2. `Ссылка на сайт`
3. `Ссылка в результатах TinEye`

Третья колонка содержит только ссылки из результатов TinEye с префиксом `https://www.shutterstock.com`.

## Входные данные

- Ручной ввод URL разделов (по одному на строку).
- Загрузка XLS/XLSX с колонкой ссылки на раздел.

Автосопоставление заголовков поддерживается (без учета регистра, пробелов, `ё=е`).

## Настройка

```bash
pip install -r requirements.txt
streamlit run app.py
```

Опционально в `.streamlit/secrets.toml`:

```toml
TINEYE_BASE_URL = "https://tineye.com"
```


## Полуавтоматический режим (рекомендуется при anti-bot)

Если TinEye показывает `Just a moment...`, используйте полуавтоматический сценарий:

1. Откройте `https://tineye.com/` в обычном браузере и вручную пройдите проверку.
2. Скопируйте cookie для `tineye.com` (формат: `name=value; name2=value2`).
3. Вставьте cookie в блок **«Сессия TinEye»** в интерфейсе приложения и нажмите **«Применить Cookie»**.
4. Запустите проверку снова — приложение выполнит запросы TinEye в этой сессии.

Если cookie устарела, приложение покажет ошибку anti-bot; просто вставьте новую cookie.

## Важно

- Ошибки отдельных карточек не останавливают обработку.
- Кэш и прогресс партий сохраняются в SQLite (`cache.db`).

- Для повышения точности извлечения изображения используются `og:image`, JSON-LD (`image`) и типовые галереи карточки.
- В логах интерфейса показываются выбранное изображение и ссылки из результатов TinEye для диагностики.


## Интерфейс

- Вкладка **Пакетная проверка разделов**: обработка разделов сайта партиями.
- Вкладка **Проверка URL**: проверка одной страницы товара по URL.
- В интерфейсе есть отдельный блок с явным сформированным TinEye URL запроса (`https://tineye.com/search?url=...`) перед отправкой.
- В интерфейсе есть блок **«Что удалось распарсить из TinEye URL»** с таблицей найденных ссылок.
- Парсинг выполняется по сформированному TinEye URL запроса с несколькими fallback-стратегиями (селекторы, `script`, домены в тексте).
- Парсинг результатов TinEye усилен fallback-механизмами (селекторы, ссылки в script, домены из текста карточек).

Параметры `top_n` и `Стартовая карточка` убраны из интерфейса; используется фиксированный лимит результатов TinEye в коде.
