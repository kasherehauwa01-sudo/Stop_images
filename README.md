# Stop_images

Streamlit-приложение для пакетной подготовки TinEye URL по карточкам товаров интернет-магазина.

## Логика работы

1. На вход подается ссылка на раздел сайта (вручную через однострочное поле или через XLS/XLSX).
   - При загрузке XLS/XLSX приложение оставляет только колонку `Ссылка` (или автоопределённый эквивалент URL) и проверяет только ссылки из неё.
2. Для каждой страницы категории выполняется:
   - HTTP-запрос с таймаутом и User-Agent,
   - проверка `status=200`,
   - фиксация `source_url` и `final_url` после редиректов.
3. Карточки товаров определяются по алгоритму повторяющегося контейнера:
   - ищутся ссылки на товар (`/catalog/`, `/product/`, `/item/`),
   - вокруг них ищется общий повторяющийся контейнер карточки,
   - извлекаются `product_url`, `name`, `preview_url`.
4. Включена дедупликация по `product_url` и обход пагинации (`?page=`, `?PAGEN_...`, цифровые страницы).
5. Для каждой карточки товара главное изображение ищется по приоритетам:
   - `og:image`,
   - JSON-LD `Product.image`,
   - галерея товара,
   - fallback по крупным изображениям.
6. В отчет попадают только товары в наличии.

## Формат отчета

Колонки строго в таком порядке:

1. `Артикул`
2. `Ссылка на сайт`
3. `TinEye URL запроса`

## Разбиение отчетов по 50 строк

Если в разделе найдено больше 50 подходящих карточек, отчет автоматически делится на несколько XLSX-файлов.

Имена файлов формируются из категории 2-го уровня URL раздела:

- `имякатегории.xlsx` — если файл один,
- `имякатегории_1.xlsx`, `имякатегории_2.xlsx`, ... — если файлов несколько.
- ZIP-архив именуется по категории (например, `aromatizatory-dlya-avto.zip`).

## Дополнительно

- Ошибки отдельных карточек логируются и не останавливают общий процесс.
- Логи показываются в интерфейсе в онлайн-режиме (с метками времени), пока идет обработка, в отдельном прокручиваемом поле (высота ~10 строк), по умолчанию свернутом.
- В интерфейсе выводится количество найденных карточек, статус текущего шага и полоса прогресса обработки (расположены над логами).
- Есть кэширование HTML-страниц и проверок изображений (HEAD/GET), чтобы не перезапрашивать одно и то же.

## Запуск

```bash
pip install -r requirements.txt
streamlit run app.py
```


## Формат ссылок в XLSX

- Колонка `Ссылка на сайт` содержит активные ссылки и автоматически подгоняется по ширине под самую длинную ссылку.
- В колонке `TinEye URL запроса` отображается анкор `Результат` с активной ссылкой на TinEye.
